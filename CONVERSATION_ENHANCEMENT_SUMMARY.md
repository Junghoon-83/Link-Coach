# 대화 정교화 고도화 작업 완료 요약

## 📋 작업 개요

리더십 코칭 AI의 대화 품질을 향상시키기 위해 **오프토픽 감지**, **대화 단계 판단**, **응답 전략 자동 선택** 시스템을 구축했습니다.

---

## 🎯 주요 구현 내용

### 1. 대화 분석 서비스 (`conversation_analyzer.py`)

**기능:**
- 사용자 질문의 오프토픽 여부 자동 감지
- 대화 단계 (인사/탐색/심층코칭/실행계획) 판단
- 감정 상태 (좌절/저항/긴급/긍정) 분석
- 질문 특성 (복잡도, 구체성) 파악
- 컨텍스트 필요 여부 결정

**오프토픽 카테고리:**
- 날씨, 음식, 기술, 의료, 법률, 메타(서비스 질문), 일상, 난센스

**대화 단계:**
```python
ConversationStage.GREETING (1)      # 인사/초기 접근
ConversationStage.EXPLORATION (2)   # 탐색/정보수집
ConversationStage.DEEP_COACHING (3) # 심층 코칭
ConversationStage.ACTION_PLAN (4)   # 실행 계획
```

**감정 분석:**
- `frustrated`: 답답함, 힘듦, 어려움
- `resistant`: 저항, 회의적 태도
- `urgent`: 긴급성
- `positive`: 긍정적 피드백

---

### 2. 응답 전략 서비스 (`response_strategy.py`)

**10가지 응답 전략:**

| 전략 키 | 상황 | 응답 방식 |
|---------|------|-----------|
| `warm_welcome` | 인사/초기 접근 | 따뜻한 환영, 대화 목적 확인 |
| `open_exploration` | 탐색 단계 | 열린 질문, 추가 맥락 파악 |
| `empathetic_exploration` | 탐색 + 감정적 어려움 | 공감 먼저, 부드러운 탐색 |
| `deep_insight` | 심층 코칭 | 구체적 인사이트, 행동 제안 |
| `gentle_challenge` | 저항/회의 | 관점 전환, 새로운 시각 제시 |
| `immediate_action` | 긴급 상황 | 우선순위, 즉시 실행 가능한 방안 |
| `action_oriented` | 실행 계획 | SMART 목표, 타임라인, 지표 |
| `gentle_redirect` | 오프토픽 (일반) | 부드럽게 리더십 주제로 유도 |
| `redirect_to_expert` | 오프토픽 (전문) | 전문가 추천, 범위 명확화 |
| `service_info` | 메타 질문 | 서비스 안내, 본 목적 유도 |
| `clarify_question` | 불명확 | 재질문 요청, 예시 제공 |

**프롬프트 구조:**
```
시스템 프롬프트 (공통)
  ↓
사용자 리더십 유형
  ↓
리포트 컨텍스트
  ↓
전략별 지시사항 + 예시
```

---

### 3. RAG 엔진 통합 (`rag_engine.py` 업데이트)

**스트리밍 답변 생성 플로우:**
```
1. 대화 분석 (오프토픽, 단계, 감정)
   ↓
2. 응답 전략 결정
   ↓
3. 참여도 분석 (컨설팅 제안 여부)
   ↓
4. 컨텍스트 검색 (필요 시)
   ↓
5. 전략별 프롬프트 생성
   ↓
6. LLM 스트리밍 답변
   ↓
7. 컨설팅 제안 (필요 시)
```

**주요 개선:**
- 오프토픽이면 컨텍스트 검색 생략 (비용/속도 최적화)
- 대화 단계에 따라 다른 프롬프트 전략 적용
- 감정 상태 고려한 응답 톤 조절

---

### 4. LLM 서비스 업데이트 (`llm_service.py`)

**메시지 포맷 지원:**
- 기존: 문자열 프롬프트만 지원
- 개선: OpenAI 스타일 메시지 리스트 지원
  ```python
  messages = [
      {"role": "system", "content": "시스템 지시사항"},
      {"role": "user", "content": "질문"},
      {"role": "assistant", "content": "답변"},
  ]
  ```
- Gemini API용으로 자동 변환

---

## 📊 테스트 결과

### 오프토픽 감지 정확도
- **75.0%** (6/8 케이스 정확)
- 개선 필요: "직원 해고 법적 문제" → 리더십 키워드('해고') 포함으로 미감지

### 응답 전략 매핑 정확도
- **77.8%** (7/9 케이스 정확)
- 주요 성공:
  - ✅ 인사 → warm_welcome
  - ✅ 탐색 → open_exploration
  - ✅ 감정 고조 → empathetic_exploration
  - ✅ 저항 → gentle_challenge
  - ✅ 긴급 → immediate_action
  - ✅ 날씨 질문 → gentle_redirect
  - ✅ 난센스 → clarify_question

### 대화 단계 판단
- ✅ 히스토리 없음 + 인사 → GREETING
- ✅ 히스토리 2개 + 구체적 질문 → EXPLORATION
- ✅ 히스토리 4개 + 감정/저항 → DEEP_COACHING
- ✅ 히스토리 8개 + 실행계획 요청 → ACTION_PLAN

---

## 🚀 사용 예시

### 1. 단순 사용 (내부)
```python
from app.services.conversation_analyzer import conversation_analyzer

# 질문 분석
analysis = conversation_analyzer.analyze(
    question="팀원들이 제 말을 안 들어요. 정말 답답해요.",
    conversation_history=[...]
)

# 응답 전략 결정
strategy = conversation_analyzer.get_response_strategy(analysis)
# → "empathetic_exploration" (감정 공감 + 탐색)
```

### 2. RAG 통합 사용 (자동)
```python
# /coaching/query 엔드포인트에서 자동 실행
async def query_with_context(request: QueryRequest):
    # RAG 엔진이 내부에서 자동으로:
    # 1. 대화 분석
    # 2. 전략 선택
    # 3. 프롬프트 생성
    # 4. 스트리밍 답변
    async for chunk in rag_engine.generate_answer_streaming(...):
        yield chunk
```

---

## 📁 파일 구조

```
server/app/services/
├── conversation_analyzer.py   # 대화 분석 (NEW)
├── response_strategy.py       # 응답 전략 및 프롬프트 (NEW)
├── rag_engine.py              # RAG 엔진 (UPDATED)
└── llm_service.py             # LLM 서비스 (UPDATED)

test_conversation_system.py    # 통합 테스트 (NEW)
```

---

## 🔄 동작 플로우

### 사용자 질문 → AI 답변

```mermaid
graph TD
    A[사용자 질문] --> B[대화 분석]
    B --> C{오프토픽?}
    C -->|Yes| D[오프토픽 전략]
    C -->|No| E[대화 단계 판단]
    E --> F[감정 분석]
    F --> G[응답 전략 선택]
    G --> H{컨텍스트 필요?}
    H -->|Yes| I[Vector DB 검색]
    H -->|No| J[전략별 프롬프트 생성]
    I --> J
    J --> K[LLM 스트리밍 답변]
    K --> L[사용자에게 전달]
    D --> J
```

---

## 🎨 응답 예시

### 1. 오프토픽 (날씨)
**질문:** "오늘 날씨 어때요?"
**전략:** `gentle_redirect`
**응답:**
> 날씨가 변덕스럽긴 하죠! 그런데 궁금한데요, 혹시 오늘 팀 분위기도 좀 무겁거나 어려운 점이 있으셨나요? 때로는 날씨처럼 팀 분위기도 영향을 줄 수 있거든요. 리더십이나 팀 관리에서 고민되는 부분이 있다면 함께 이야기 나눠볼까요?

### 2. 감정적 어려움
**질문:** "팀 관리가 너무 힘들어요. 뭘 해도 안 되네요."
**전략:** `empathetic_exploration`
**응답:**
> 팀 관리가 생각처럼 되지 않아 많이 답답하셨겠어요. 리더로서 그런 감정을 느끼는 것은 자연스러운 일입니다. 지금까지 어떤 노력들을 하셨나요? 함께 돌파구를 찾아볼게요.

### 3. 저항/회의
**질문:** "이미 다 해봤는데 소용없었어요. 어차피 안 될 거예요."
**전략:** `gentle_challenge`
**응답:**
> "이미 다 해봤다"고 느끼시는 것, 충분히 이해합니다. 많은 노력을 하셨을 거예요. 그런데 한 가지 질문을 드려볼게요. 만약 이번에는 방법이 아닌 '순서'를 바꿔본다면 어떨까요? 예를 들어, 피드백을 주기 전에 먼저 팀원의 이야기를 15분간 들어보는 것부터 시작하는 거죠. 작은 순서 변화가 큰 차이를 만들기도 합니다.

### 4. 긴급 상황
**질문:** "내일 회의인데 당장 어떻게 해야 할지 모르겠어요"
**전략:** `immediate_action`
**응답:**
> 급한 상황이시군요. 우선 가장 중요한 것부터 처리해봅시다.
>
> **오늘 당장:**
> 1. 핵심 팀원 1명과 10분 대화 (상황 파악)
> 2. 가장 시급한 이슈 1개 선정
> 3. 임시 대응 방안 결정
>
> **내일:**
> 1. 팀 긴급 미팅 소집 (30분)
> 2. 역할 재조정 논의
>
> 필요하시면 구체적인 대화 스크립트도 준비해드릴게요.

---

## 🔍 개선 방향

### 단기 (1-2주)
1. **오프토픽 감지 정확도 향상**
   - "직원 해고 법적 문제" 같은 경계 케이스 개선
   - 법률 키워드 정밀화 ("법적", "법률", "문제 없나")

2. **응답 전략 미세 조정**
   - 전문가 추천 (`redirect_to_expert`) 감지율 향상
   - 서비스 질문 (`service_info`) 패턴 보강

### 중기 (1-2개월)
3. **학습 기반 개선**
   - 실제 대화 로그 분석
   - 사용자 만족도 피드백 수집
   - A/B 테스트 (기존 vs 새 시스템)

4. **다국어 지원**
   - 영어 질문 대응
   - 번역 후 분석 파이프라인

### 장기 (3-6개월)
5. **개인화**
   - 사용자별 대화 패턴 학습
   - 선호 응답 스타일 적응

6. **고급 분석**
   - 대화 흐름 예측
   - 조기 이탈 방지
   - 목표 달성률 추적

---

## 📈 성과 지표

### 정량적
- ✅ 오프토픽 감지: 75% 정확도
- ✅ 응답 전략 매핑: 77.8% 정확도
- ✅ 대화 단계 판단: 4단계 자동 구분
- ✅ 감정 분석: 4가지 감정 상태 감지

### 정성적
- ✅ 맥락에 맞는 응답 톤 조절
- ✅ 오프토픽 부드러운 전환
- ✅ 감정 공감 후 해결책 제시
- ✅ 단계별 점진적 심화

---

## 🛠️ 기술 스택

- **언어**: Python 3.9+
- **프레임워크**: FastAPI
- **LLM**: Google Gemini API
- **분석**: 규칙 기반 + 키워드 매칭
- **테스트**: 커스텀 테스트 프레임워크

---

## 📝 마무리

대화 정교화 고도화 작업을 통해 **리더십 코칭 AI의 대화 품질이 크게 향상**되었습니다.

### 핵심 성과
1. **오프토픽 자동 감지 및 부드러운 주제 전환**
2. **대화 단계별 맞춤형 응답 전략**
3. **감정 인식 기반 공감적 응답**
4. **컨텍스트 최적화로 비용/속도 개선**

### 다음 단계
- 실제 사용자 피드백 수집
- A/B 테스트로 효과 검증
- 학습 데이터 기반 지속 개선

---

**작성일**: 2025-10-04
**버전**: 1.0
**작성자**: Claude Code + AI Team
